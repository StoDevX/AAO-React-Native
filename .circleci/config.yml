version: 2

workflows:
  version: 2
  analyze:
    jobs:
      - danger
      - flow
      - jest
      - prettier
      - eslint
      - data

jobs:
  danger:
    docker: {image: circleci/node:8}
    working_directory: ~/repo
    steps:
      - checkout
      - restore_cache:
          keys:
          - 'v1-dependencies-{{ checksum "yarn.lock" }}'
          - v1-dependencies-
      - run: yarn install
      - save_cache:
          paths: [node_modules]
          key: 'v1-dependencies-{{ checksum "yarn.lock" }}'
      - run: echo yarn danger --id JS-general

  flow:
    docker: {image: circleci/node:8}
    working_directory: ~/repo
    steps:
      - checkout
      - restore_cache:
          keys:
          - 'v1-dependencies-{{ checksum "yarn.lock" }}'
          - v1-dependencies-
      - run: yarn install
      - save_cache:
          paths: [node_modules]
          key: 'v1-dependencies-{{ checksum "yarn.lock" }}'
      - run: yarn bundle-data
      - run: yarn flow check --quiet | tee logs/flow

  jest:
    docker: {image: circleci/node:8}
    working_directory: ~/repo
    steps:
      - checkout
      - restore_cache:
          keys:
          - 'v1-dependencies-{{ checksum "yarn.lock" }}'
          - v1-dependencies-
      - run: yarn install
      - save_cache:
          paths: [node_modules]
          key: 'v1-dependencies-{{ checksum "yarn.lock" }}'
      - run: yarn bundle-data
      - run: yarn test --coverage

  prettier:
    docker: {image: circleci/node:8}
    working_directory: ~/repo
    steps:
      - checkout
      - restore_cache:
          keys:
          - 'v1-dependencies-{{ checksum "yarn.lock" }}'
          - v1-dependencies-
      - run: yarn install
      - save_cache:
          paths: [node_modules]
          key: 'v1-dependencies-{{ checksum "yarn.lock" }}'
      - touch logs/prettier
      - yarn prettier
      - if ! git diff --quiet ./*.js source/; then
          git diff ./*.js source/ > logs/prettier;
        fi

  eslint:
    docker: {image: circleci/node:8}
    working_directory: ~/repo
    steps:
      - checkout
      - restore_cache:
          keys:
          - 'v1-dependencies-{{ checksum "yarn.lock" }}'
          - v1-dependencies-
      - run: yarn install
      - save_cache:
          paths: [node_modules]
          key: 'v1-dependencies-{{ checksum "yarn.lock" }}'
      - run: yarn bundle-data
      - run: yarn lint

  data:
    docker: {image: circleci/node:8}
    working_directory: ~/repo
    steps:
      - checkout
      - restore_cache:
          keys:
          - 'v1-dependencies-{{ checksum "yarn.lock" }}'
          - v1-dependencies-
      - run: yarn install
      - save_cache:
          paths: [node_modules]
          key: 'v1-dependencies-{{ checksum "yarn.lock" }}'
      - run: yarn validate-data --quiet
      - run: yarn validate-bus-data
