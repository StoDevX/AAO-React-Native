---
env:
  global:
    # variables from the web interface:
    # - GH_TOKEN: token to push to the repo for greenkeeper
    # - GITHUB_PAGES_TOKEN: token to push to gh-pages
    # sets our node version in one nice place
    - TRAVIS_NODE_VERSION=10


# As seen in http://stackoverflow.com/a/31882307/2347774
# Prevent travis from building twice for PRs
branches:
  only:
    - master
    - /^greenkeeper\//


stages:
  - name: Greenkeeper
    if: branch =~ /^greenkeeper\//
  - name: Deploy Data
    if: branch = master AND type != pull_request


jobs:
  include:
    # Run greenkeeper stuff
    - os: linux
      sudo: false
      distro: trusty
      language: node_js
      node_js: $TRAVIS_NODE_VERSION
      stage: Greenkeeper
      env: [task=GREENKEEPER]
      install: npm install -g greenkeeper-lockfile@1
      script: greenkeeper-lockfile-update
      after_script: greenkeeper-lockfile-upload

    # Deploy the gh-pages data
    - os: linux
      sudo: false
      distro: trusty
      language: node_js
      node_js: $TRAVIS_NODE_VERSION
      stage: Deploy Data
      env: [task=GH_PAGES]
      install: yarn || yarn
      script:
        - npm run validate-bus-data
        - npm run validate-data
        - npm run bundle-data
      deploy:
        provider: pages
        skip_cleanup: true
        github_token: $GITHUB_PAGES_TOKEN
        local_dir: docs/

cache:
  yarn: true

notifications:
  webhooks:
    urls:
      - https://discordapp.com/api/webhooks/477651404085919747/DezH4DOZQOm2wOFHY_BjYDlOCGmS5lDsasu-P4URfqVWvzb5CLCXV9_lKiM-bu3KP_VF
    on_success: change
    on_failure: always
    on_start: change
    on_cancel: always
    on_error: always
