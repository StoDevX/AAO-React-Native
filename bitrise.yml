---
# Any edits to this file must be copied into the online editor at
# https://www.bitrise.io/app/bc51be6a59ccbc35/workflow/editor
# and saved there.
format_version: 1.3.1
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git
trigger_map:
- push_branch: fastlane-test
  workflow: hockeyapp
- push_branch: master
  workflow: hockeyapp
- push_branch: master
  workflow: test
- push_branch: bitrise
  workflow: test
- pull_request_source_branch: "*"
  workflow: test
workflows:
  test:
    steps:
    - activate-ssh-key@3.1.1:
        run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
    - git-clone@3.4.1: {}
    - script@1.1.3:
        title: initial setup
        inputs:
        - content: |-
            #!/bin/bash
            set -exv
            touch .env.js
    - certificate-and-profile-installer@1.8.1: {}
    - npm@0.1.1:
        title: npm install
        inputs:
        - command: install
    - npm@0.1.1:
        title: npm build
        inputs:
        - command: run build:ios
  hockeyapp:
    steps:
    - activate-ssh-key@3.1.1:
        run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
    - git-clone@3.4.1: {}
    - script@1.1.3:
        title: apply fastlane
        inputs:
        - content: |-
            #!/bin/bash
            set -exv
            git status

            if [[ "$BITRISE_GIT_BRANCH" -eq "testing" ]];
              then fastlane_branch="fastlane-for-testing"
              else fastlane_branch="fastlane-for-master"
            fi
            echo "fastlane_branch is '$fastlane_branch'"

            set +e
            git branch -D "$fastlane_branch"
            set -e
            git checkout "$fastlane_branch"
            git status

            git rebase "$GIT_CLONE_COMMIT_HASH"
            git status

            cat fastlane/Fastfile
    - script@1.1.3:
        title: yarn
        inputs:
        - content: |-
            #!/bin/bash
            set -exv
            curl -sL -o- https://yarnpkg.com/install.sh | bash
            $HOME/.yarn/bin/yarn --ignore-engines
    - script@1.1.3:
        title: bundle
        inputs:
        - content: |-
            #!/bin/bash
            set -exv
            sudo /usr/bin/gem install bundler --no-document
            bundle install
    - script@1.1.3:
        title: bitrise/sierra/match workaround
        inputs:
        - content: |-
            #!/bin/bash
            set -exv
            export BITRISE_KEYCHAIN_PATH=$HOME/Library/Keychains/login.keychain
            export MATCH_KEYCHAIN_PASSWORD="${BITRISE_KEYCHAIN_PASSWORD}"
            bundle exec match development --readonly
            security set-key-partition-list -S apple-tool:,apple: -k "$BITRISE_KEYCHAIN_PASSWORD" "$BITRISE_KEYCHAIN_PATH"
    - script@1.1.3:
        title: prepare special files
        inputs:
        - content: |-
            #!/bin/bash
            set -exv
            touch .env.js
            echo "export const GOOGLE_CALENDAR_API_KEY = '$GCAL_API'" > .env.js
    - fastlane@2.2.0:
        inputs:
        - lane: ios beta_ci
