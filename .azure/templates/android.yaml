parameters:
  signed: false
  is_nightly: false
  is_beta: false
  SENTRY_PROPERTIES: ../android/sentry.properties

steps:
  - bash: mkdir -p logs/
    displayName: 'Set up /logs'

  - bash: yarn install --frozen-lockfile
    displayName: 'Install dependencies (yarn)'

  - bash: bundle install --frozen --path ./vendor/bundle
    displayName: 'Install dependencies (bundler)'

  - bash: ./scripts/ci/propagate-version.rb
    displayName: 'Propagate build number into app version file'

  - bash: cd android && ./gradlew androidDependencies
    displayName: 'Install dependencies (gradle)'

  - ${{ if eq(parameters.signed, true) }}:
      - bash: ./scripts/ci/authorize-ci-for-keys.rb
        displayName: '[signed=true] Authorize CI for GitHub access'

      - bash: ./scripts/ci/android/certificates.sh
        displayName: '[signed=true] Initialize signing certificates'
        env:
          GITHUB_KEYS_REPOSITORY_TOKEN: $(GITHUB_KEYS_REPOSITORY_TOKEN)
          MATCH_PASSWORD: $(MATCH_PASSWORD)

  - bash: cd ./android && ./gradlew bundleRelease
    displayName: 'Build app with Gradle'

  - bash: ./scripts/ci/android/discover-products.sh | tee ./logs/products
    displayName: 'Record .aab products to logfile'

  - ${{ if eq(parameters.is_beta, True) }}:
      - bash: bundle exec fastlane run upload_to_play_store
          --aab $(paste -sd "," < ./logs/products)
          --check_superseded_tracks true
          --track beta
        displayName: '[beta=true] Upload to Google Play'

  - ${{ if eq(parameters.is_nightly, True) }}:
      - bash: bundle exec fastlane run upload_to_play_store
          --aab $(paste -sd "," < ./logs/products)
          --check_superseded_tracks true
          --track alpha
        displayName: '[nightly=true] Upload to Google Play'

  - ${{ if or(eq(parameters.is_nightly, True), eq(parameters.is_beta, True)) }}:
      - bash: ./scripts/ci/sourcemap-create.sh
        displayName: '[nightly || beta] Generate sourcemap'
      - bash: ./scripts/ci/sourcemap-upload.sh
        displayName: '[nightly || beta] Upload sourcemap to Sentry'
