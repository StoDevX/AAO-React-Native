parameters:
  signed: false
  is_nightly: false
  is_beta: false
  SENTRY_PROPERTIES: ../android/sentry.properties

steps:
  - bash: mkdir -p logs/
    displayName: 'Set up /logs'

  - bash: yarn install --frozen-lockfile
    displayName: 'Install dependencies (yarn)'

  - bash: bundle install --frozen --path ./vendor/bundle
    displayName: 'Install dependencies (bundler)'

  - bash: ./scripts/ci/propagate-version.rb
    displayName: 'Propagate build number into app version file'

  - bash: cd android && ./gradlew androidDependencies
    displayName: 'Install dependencies (gradle)'

  - ${{ if eq(parameters.signed, true) }}:
    - bash: ./scripts/ci/authorize-ci-for-keys.rb
      displayName: 'Authorize CI for GitHub access'

    - bash: ./scripts/ci/android/certificates.sh
      displayName: 'Initialize signing certificates'
      env:
        GITHUB_KEYS_REPOSITORY_TOKEN: $(GITHUB_KEYS_REPOSITORY_TOKEN)
        MATCH_PASSWORD: $(MATCH_PASSWORD)

  - bash: ./android/gradlew bundleRelease
    displayName: 'Build app with Gradle'

  - bash: ./scripts/ci/android/discover-products.sh | ./logs/products
    displayName: 'Set up products logfile'

  - ${{ if eq(parameters.is_beta, true) }}:
    - bash:
        bundle exec fastlane run upload_to_play_store
          --aab $(format('$(paste -sd "," < ./logs/products)'))
          --check_superseded_tracks true
          --track beta
      displayName: 'Upload to Google Play'

  - ${{ if eq(parameters.is_nightly, true) }}:
    - bash:
        bundle exec fastlane run upload_to_play_store
          --aab $(format('$(paste -sd "," < ./logs/products)'))
          --check_superseded_tracks true
          --track alpha
      displayName: 'Upload to Google Play'

  - ${{ if or(parameters.is_nightly, parameters.is_beta) }}:
    - bash: ./scripts/ci/sourcemap-create.sh
      displayName: 'Generate sourcemap'
    - bash: ./scripts/ci/sourcemap-upload.sh
      displayName: 'Upload sourcemap to Sentry'
